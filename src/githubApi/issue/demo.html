<div class="markdown-body"><p>如果在条件语句中使用hooks，React会抛出 error。</p>
  <p>这与React Hooks的底层设计的数据结构相关，先抛出结论：<strong>react用链表来严格保证hooks的顺序</strong>。</p>
  <p>一个典型的useState使用场景：</p>
  <pre><div class="codeBox___24JI7"><button class="copyBtn___3UMAO">复制</button><div style="color: rgb(197, 200, 198); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Inconsolata, Monaco, Consolas, &quot;Courier New&quot;, Courier, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: auto; border-radius: 0.3em; background: rgb(29, 31, 33);"><code class="language-js" style="color: rgb(197, 200, 198); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Inconsolata, Monaco, Consolas, &quot;Courier New&quot;, Courier, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">1</span><span class="token" style="color: rgb(150, 203, 254);">const</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">[</span><span>name</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>setName</span><span class="token" style="color: rgb(197, 200, 198);">]</span><span> </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> </span><span class="token" style="color: rgb(218, 208, 133);">useState</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(168, 255, 96);">'leo'</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">2</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">3</span><span></span><span class="token spread" style="color: rgb(237, 237, 237);">...</span><span class="token spread" style="color: rgb(237, 237, 237);">...</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">4</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">5</span><span></span><span class="token method property-access" style="color: rgb(218, 208, 133);">setName</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(168, 255, 96);">'Lily'</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token" style="color: rgb(197, 200, 198);">;</span></code></div></div></pre>
  <p>那么hooks在这两条语句分别作了什么？</p>
  <p><div class="ant-image"><img class="ant-image-img" src="https://pic.rmb.bdstatic.com/bjh/89d2fa7124b06495bbbfd4b5758bd6e5.png"><div class="ant-image-mask"><div class="ant-image-mask-info"><span role="img" aria-label="eye" class="anticon anticon-eye"><svg viewBox="64 64 896 896" focusable="false" data-icon="eye" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M942.2 486.2C847.4 286.5 704.1 186 512 186c-192.2 0-335.4 100.5-430.2 300.3a60.3 60.3 0 000 51.5C176.6 737.5 319.9 838 512 838c192.2 0 335.4-100.5 430.2-300.3 7.7-16.2 7.7-35 0-51.5zM512 766c-161.3 0-279.4-81.8-362.7-254C232.6 339.8 350.7 258 512 258c161.3 0 279.4 81.8 362.7 254C791.5 684.2 673.4 766 512 766zm-4-430c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176-78.8-176-176-176zm0 288c-61.9 0-112-50.1-112-112s50.1-112 112-112 112 50.1 112 112-50.1 112-112 112z"></path></svg></span>预览</div></div></div></p>
  <p>上图是 <code>useState</code> 首次渲染的路径，其中，跟我们问题相关的是 <code>mountState</code> 这个过程，简而言之，这个过程初始化了一个hooks，并且将其追加到链表结尾。</p>
  <pre><div class="codeBox___24JI7"><button class="copyBtn___3UMAO">复制</button><div style="color: rgb(197, 200, 198); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Inconsolata, Monaco, Consolas, &quot;Courier New&quot;, Courier, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: auto; border-radius: 0.3em; background: rgb(29, 31, 33);"><code class="language-js" style="color: rgb(197, 200, 198); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Inconsolata, Monaco, Consolas, &quot;Courier New&quot;, Courier, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">1</span><span class="token" style="color: rgb(124, 124, 124);">// 进入 mounState 逻辑</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">2</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">3</span><span></span><span class="token" style="color: rgb(150, 203, 254);">function</span><span> </span><span class="token" style="color: rgb(218, 208, 133);">mountState</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token parameter">initialState</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">4</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">5</span><span>  </span><span class="token" style="color: rgb(124, 124, 124);">// 将新的 hook 对象追加进链表尾部</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">6</span><span>  </span><span class="token" style="color: rgb(150, 203, 254);">var</span><span> hook </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> </span><span class="token" style="color: rgb(218, 208, 133);">mountWorkInProgressHook</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">7</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">8</span><span>  </span><span class="token" style="color: rgb(124, 124, 124);">// initialState 可以是一个回调，若是回调，则取回调执行后的值</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">9</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">10</span><span>  </span><span class="token control-flow" style="color: rgb(150, 203, 254);">if</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(150, 203, 254);">typeof</span><span> initialState </span><span class="token" style="color: rgb(237, 237, 237);">===</span><span> </span><span class="token" style="color: rgb(168, 255, 96);">'function'</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">11</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">12</span><span>    </span><span class="token" style="color: rgb(124, 124, 124);">// $FlowFixMe: Flow doesn't like mixed types</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">13</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">14</span><span>    initialState </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> </span><span class="token" style="color: rgb(218, 208, 133);">initialState</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">15</span><span>  </span><span class="token" style="color: rgb(197, 200, 198);">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">16</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">17</span><span>  </span><span class="token" style="color: rgb(124, 124, 124);">// 创建当前 hook 对象的更新队列，这一步主要是为了能够依序保留 dispatch</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">18</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">19</span><span>  </span><span class="token" style="color: rgb(150, 203, 254);">const</span><span> queue </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> hook</span><span class="token" style="color: rgb(197, 200, 198);">.</span><span class="token property-access">queue</span><span> </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">20</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">21</span><span>    last</span><span class="token" style="color: rgb(237, 237, 237);">:</span><span> </span><span class="token null nil" style="color: rgb(150, 203, 254);">null</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">22</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">23</span><span>    dispatch</span><span class="token" style="color: rgb(237, 237, 237);">:</span><span> </span><span class="token null nil" style="color: rgb(150, 203, 254);">null</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">24</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">25</span><span>    lastRenderedReducer</span><span class="token" style="color: rgb(237, 237, 237);">:</span><span> basicStateReducer</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">26</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">27</span><span>    lastRenderedState</span><span class="token" style="color: rgb(237, 237, 237);">:</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">(</span><span>initialState</span><span class="token" style="color: rgb(237, 237, 237);">:</span><span> any</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">28</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">29</span><span>  </span><span class="token" style="color: rgb(197, 200, 198);">}</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">30</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">31</span><span>  </span><span class="token" style="color: rgb(124, 124, 124);">// 将 initialState 作为一个“记忆值”存下来</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">32</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">33</span><span>  hook</span><span class="token" style="color: rgb(197, 200, 198);">.</span><span class="token property-access">memoizedState</span><span> </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> hook</span><span class="token" style="color: rgb(197, 200, 198);">.</span><span class="token property-access">baseState</span><span> </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> initialState</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">34</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">35</span><span>  </span><span class="token" style="color: rgb(124, 124, 124);">// dispatch 是由上下文中一个叫 dispatchAction 的方法创建的，这里不必纠结这个方法具体做了什么</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">36</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">37</span><span>  </span><span class="token" style="color: rgb(150, 203, 254);">var</span><span> dispatch </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> queue</span><span class="token" style="color: rgb(197, 200, 198);">.</span><span class="token property-access">dispatch</span><span> </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> dispatchAction</span><span class="token" style="color: rgb(197, 200, 198);">.</span><span class="token method property-access" style="color: rgb(218, 208, 133);">bind</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token null nil" style="color: rgb(150, 203, 254);">null</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span> currentlyRenderingFiber$</span><span class="token" style="color: rgb(255, 115, 253);">1</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span> queue</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">38</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">39</span><span>  </span><span class="token" style="color: rgb(124, 124, 124);">// 返回目标数组，dispatch 其实就是示例中常常见到的 setXXX 这个函数，想不到吧？哈哈</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">40</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">41</span><span>  </span><span class="token control-flow" style="color: rgb(150, 203, 254);">return</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">[</span><span>hook</span><span class="token" style="color: rgb(197, 200, 198);">.</span><span class="token property-access">memoizedState</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span> dispatch</span><span class="token" style="color: rgb(197, 200, 198);">]</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">42</span><span></span><span class="token" style="color: rgb(197, 200, 198);">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">43</span>
</code></div></div></pre>
  <p>从这段源码中我们可以看出，mounState 的主要工作是初始化 Hooks。在整段源码中，最需要关注的是 <code>mountWorkInProgressHook</code> 方法，它为我们道出了 Hooks 背后的数据结构组织形式。以下是 <code>mountWorkInProgressHook</code> 方法的源码：</p>
  <pre><div class="codeBox___24JI7"><button class="copyBtn___3UMAO">复制</button><div style="color: rgb(197, 200, 198); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Inconsolata, Monaco, Consolas, &quot;Courier New&quot;, Courier, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: auto; border-radius: 0.3em; background: rgb(29, 31, 33);"><code class="language-js" style="color: rgb(197, 200, 198); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Inconsolata, Monaco, Consolas, &quot;Courier New&quot;, Courier, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">1</span><span class="token" style="color: rgb(150, 203, 254);">function</span><span> </span><span class="token" style="color: rgb(218, 208, 133);">mountWorkInProgressHook</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">2</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">3</span><span>  </span><span class="token" style="color: rgb(124, 124, 124);">// 注意，单个 hook 是以对象的形式存在的</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">4</span><span>  </span><span class="token" style="color: rgb(150, 203, 254);">var</span><span> hook </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">5</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">6</span><span>    memoizedState</span><span class="token" style="color: rgb(237, 237, 237);">:</span><span> </span><span class="token null nil" style="color: rgb(150, 203, 254);">null</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">7</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">8</span><span>    baseState</span><span class="token" style="color: rgb(237, 237, 237);">:</span><span> </span><span class="token null nil" style="color: rgb(150, 203, 254);">null</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">9</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">10</span><span>    baseQueue</span><span class="token" style="color: rgb(237, 237, 237);">:</span><span> </span><span class="token null nil" style="color: rgb(150, 203, 254);">null</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">11</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">12</span><span>    queue</span><span class="token" style="color: rgb(237, 237, 237);">:</span><span> </span><span class="token null nil" style="color: rgb(150, 203, 254);">null</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">13</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">14</span><span>    next</span><span class="token" style="color: rgb(237, 237, 237);">:</span><span> </span><span class="token null nil" style="color: rgb(150, 203, 254);">null</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">15</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">16</span><span>  </span><span class="token" style="color: rgb(197, 200, 198);">}</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">17</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">18</span><span>  </span><span class="token control-flow" style="color: rgb(150, 203, 254);">if</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">(</span><span>workInProgressHook </span><span class="token" style="color: rgb(237, 237, 237);">===</span><span> </span><span class="token null nil" style="color: rgb(150, 203, 254);">null</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">19</span><span>    </span><span class="token" style="color: rgb(124, 124, 124);">// 这行代码每个 React 版本不太一样，但做的都是同一件事：将 hook 作为链表的头节点处理</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">20</span><span>    firstWorkInProgressHook </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> workInProgressHook </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> hook</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">21</span><span>  </span><span class="token" style="color: rgb(197, 200, 198);">}</span><span> </span><span class="token control-flow" style="color: rgb(150, 203, 254);">else</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">22</span><span>    </span><span class="token" style="color: rgb(124, 124, 124);">// 若链表不为空，则将 hook 追加到链表尾部</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">23</span><span>    workInProgressHook </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> workInProgressHook</span><span class="token" style="color: rgb(197, 200, 198);">.</span><span class="token property-access">next</span><span> </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> hook</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">24</span><span>  </span><span class="token" style="color: rgb(197, 200, 198);">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">25</span><span>  </span><span class="token" style="color: rgb(124, 124, 124);">// 返回当前的 hook</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">26</span><span>  </span><span class="token control-flow" style="color: rgb(150, 203, 254);">return</span><span> workInProgressHook</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">27</span><span></span><span class="token" style="color: rgb(197, 200, 198);">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 2.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">28</span>
</code></div></div></pre>
  <p>到这里可以看出，hook 相关的所有信息收敛在一个 hook 对象里，而 hook 对象之间以单向链表的形式相互串联。</p>
  <p>接着，我们来看更新过程</p>
  <p><div class="ant-image"><img class="ant-image-img" src="https://pic.rmb.bdstatic.com/bjh/1cc5bd4c72e4f22d1aa828df3c831f2d.png"><div class="ant-image-mask"><div class="ant-image-mask-info"><span role="img" aria-label="eye" class="anticon anticon-eye"><svg viewBox="64 64 896 896" focusable="false" data-icon="eye" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M942.2 486.2C847.4 286.5 704.1 186 512 186c-192.2 0-335.4 100.5-430.2 300.3a60.3 60.3 0 000 51.5C176.6 737.5 319.9 838 512 838c192.2 0 335.4-100.5 430.2-300.3 7.7-16.2 7.7-35 0-51.5zM512 766c-161.3 0-279.4-81.8-362.7-254C232.6 339.8 350.7 258 512 258c161.3 0 279.4 81.8 362.7 254C791.5 684.2 673.4 766 512 766zm-4-430c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176-78.8-176-176-176zm0 288c-61.9 0-112-50.1-112-112s50.1-112 112-112 112 50.1 112 112-50.1 112-112 112z"></path></svg></span>预览</div></div></div></p>
  <p>上图中，需要注意的是updateState的过程：按顺序去遍历之前构建好的链表，取出对应的数据信息进行渲染。</p>
  <p>我们把 mountState 和 updateState 做的事情放在一起来看：mountState（首次渲染）构建链表并渲染；updateState 依次遍历链表并渲染。</p>
  <p>hooks 的渲染是通过“依次遍历”来定位每个 hooks 内容的。如果前后两次读到的链表在顺序上出现差异，那么渲染的结果自然是不可控的。</p>
  <p>这个现象有点像我们构建了一个长度确定的数组，数组中的每个坑位都对应着一块确切的信息，后续每次从数组里取值的时候，只能够通过索引（也就是位置）来定位数据。也正因为如此，在许多文章里，都会直截了当地下这样的定义：Hooks 的本质就是数组。但读完这一课时的内容你就会知道，Hooks 的本质其实是链表。</p>
  <p>我们举个例子：</p>
  <pre><div class="codeBox___24JI7"><button class="copyBtn___3UMAO">复制</button><div style="color: rgb(197, 200, 198); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Inconsolata, Monaco, Consolas, &quot;Courier New&quot;, Courier, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none; padding: 1em; margin: 0.5em 0px; overflow: auto; border-radius: 0.3em; background: rgb(29, 31, 33);"><code class="language-js" style="color: rgb(197, 200, 198); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px; font-family: Inconsolata, Monaco, Consolas, &quot;Courier New&quot;, Courier, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 4; hyphens: none;"><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">1</span><span>    </span><span class="token" style="color: rgb(150, 203, 254);">let</span><span> mounted </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> </span><span class="token" style="color: rgb(153, 204, 153);">false</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">2</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">3</span><span>    </span><span class="token control-flow" style="color: rgb(150, 203, 254);">if</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(237, 237, 237);">!</span><span>mounted</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token" style="color: rgb(197, 200, 198);">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">4</span><span>        </span><span class="token" style="color: rgb(124, 124, 124);">// eslint-disable-next-line</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">5</span><span>        </span><span class="token" style="color: rgb(150, 203, 254);">const</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">[</span><span>name</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>setName</span><span class="token" style="color: rgb(197, 200, 198);">]</span><span> </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> </span><span class="token" style="color: rgb(218, 208, 133);">useState</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(168, 255, 96);">'leo'</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">6</span><span>        </span><span class="token" style="color: rgb(150, 203, 254);">const</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">[</span><span>age</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>setAge</span><span class="token" style="color: rgb(197, 200, 198);">]</span><span> </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> </span><span class="token" style="color: rgb(218, 208, 133);">useState</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(255, 115, 253);">18</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">7</span><span>        mounted </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> </span><span class="token" style="color: rgb(153, 204, 153);">true</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">8</span><span>    </span><span class="token" style="color: rgb(197, 200, 198);">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">9</span><span>    </span><span class="token" style="color: rgb(150, 203, 254);">const</span><span> </span><span class="token" style="color: rgb(197, 200, 198);">[</span><span>career</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>setCareer</span><span class="token" style="color: rgb(197, 200, 198);">]</span><span> </span><span class="token" style="color: rgb(237, 237, 237);">=</span><span> </span><span class="token" style="color: rgb(218, 208, 133);">useState</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(168, 255, 96);">'码农'</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">10</span><span>    </span><span class="token console" style="color: rgb(255, 255, 182); text-decoration: underline;">console</span><span class="token" style="color: rgb(197, 200, 198);">.</span><span class="token method property-access" style="color: rgb(218, 208, 133);">log</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(168, 255, 96);">'career'</span><span class="token" style="color: rgb(197, 200, 198);">,</span><span>career</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token" style="color: rgb(197, 200, 198);">;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">11</span><span>    </span><span class="token spread" style="color: rgb(237, 237, 237);">...</span><span class="token spread" style="color: rgb(237, 237, 237);">...</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">12</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">13</span><span>    </span><span class="token" style="color: rgb(237, 237, 237);">&lt;</span><span>div onClick</span><span class="token" style="color: rgb(237, 237, 237);">=</span><span class="token" style="color: rgb(197, 200, 198);">{</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token arrow" style="color: rgb(237, 237, 237);">=&gt;</span><span class="token" style="color: rgb(218, 208, 133);">setName</span><span class="token" style="color: rgb(197, 200, 198);">(</span><span class="token" style="color: rgb(168, 255, 96);">'Lily'</span><span class="token" style="color: rgb(197, 200, 198);">)</span><span class="token" style="color: rgb(197, 200, 198);">}</span><span class="token" style="color: rgb(237, 237, 237);">&gt;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">14</span>    点我点我点我
<span class="linenumber react-syntax-highlighter-line-number" style="display: inline-block; min-width: 3.25em; padding-right: 1em; text-align: right; user-select: none; color: rgb(124, 124, 124);">15</span><span>    </span><span class="token" style="color: rgb(237, 237, 237);">&lt;</span><span>div</span><span class="token" style="color: rgb(237, 237, 237);">&gt;</span></code></div></div></pre>
  <p>点击div后，我们期望的输出是 "码农"，然而事实上(尽管会error，但是打印还是执行)打印的为 "Lily"</p>
  <p>原因是，三个useState在初始化的时候已经构建好了一个三个节点的链表结构，依次为：
    <code>name('leo') --&gt; age(18) --&gt; career('码农')</code></p>
  <p>每个节点都已经派发了一个与之对应的update操作，因此执行setName时候，三个节点就修改为了
    <code>name('Lily') --&gt; age(18) --&gt; career('码农')</code></p>
  <p>然后执行update渲染操作，从链表依次取出值，此时，条件语句的不再执行，第一个取值操作会从链表的第一个，也就是name对应的hooks对象进行取值：此时取到的为 <code>name:Lily</code></p>
  <p>必须按照顺序调用从根本上来说是因为 useState 这个钩子在设计层面并没有“状态命名”这个动作，也就是说你每生成一个新的状态，React 并不知道这个状态名字叫啥，所以需要通过顺序来索引到对应的状态值</p></div>
