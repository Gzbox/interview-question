<div class="markdown-body cache html"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><h1 data-id="heading-0">写在前面</h1>
  <p>今年国庆假期终于可以憋在家里了不用出门了，不用出去看后脑了，真的是一种享受。这么好的光阴怎么浪费，睡觉、吃饭、打豆豆这怎么可能（耍多了也烦），完全不符合我们程序员的作风，赶紧起来把文章写完。</p>
  <p>这篇文章比较基础，在国庆期间的业余时间写的，这几天又完善了下，力求把更多的前端所涉及到的关于文件上传的各种场景和应用都涵盖了,若有疏漏和问题还请留言斧正和补充。</p>
  <h1 data-id="heading-1">自测读不读</h1>
  <p>以下是本文所涉及到的知识点，break or continue ?</p>
  <ul>
    <li>文件上传原理</li>
    <li>最原始的文件上传</li>
    <li>使用 koa2 作为服务端写一个文件上传接口</li>
    <li>单文件上传和上传进度</li>
    <li>多文件上传和上传进度</li>
    <li>拖拽上传</li>
    <li>剪贴板上传</li>
    <li>大文件上传之分片上传</li>
    <li>大文件上传之断点续传</li>
    <li>node 端文件上传</li>
  </ul>
  <h1 data-id="heading-2">原理概述</h1>
  <p>原理很简单，就是根据 http 协议的规范和定义，完成请求消息体的封装和消息体的解析，然后将二进制内容保存到文件。</p>
  <p>我们都知道如果要上传一个文件，需要把 form 标签的<code>enctype</code>设置为<code>multipart/form-data</code>,同时<code>method</code>必须为<code>post</code>方法。</p>
  <p>那么<code>multipart/form-data</code>表示什么呢？</p>
  <blockquote>
    <p>multipart互联网上的混合资源，就是资源由多种元素组成，form-data表示可以使用HTML Forms 和 POST 方法上传文件，具体的定义可以参考RFC 7578。</p>
  </blockquote>
  <p><code>multipart/form-data</code> 结构</p>
  <p>看下 http 请求的消息体</p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3d4c4d605f53~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <ul>
    <li>请求头：</li>
  </ul>
  <p><code>Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryDCntfiXcSkPhS4PN</code> 表示本次请求要上传文件，其中boundary表示分隔符，如果要上传多个表单项，就要使用boundary分割，每个表单项由———XXX开始，以———XXX结尾。</p>
  <ul>
    <li>消息体- Form Data 部分</li>
  </ul>
  <p>每一个表单项又由<code>Content-Type</code>和<code>Content-Disposition</code>组成。</p>
  <p><code>Content-Disposition: form-data</code> 为固定值，表示一个表单元素，<code>name</code> 表示表单元素的 名称，回车换行后面就是<code>name</code>的值，如果是上传文件就是文件的二进制内容。</p>
  <p><code>Content-Type</code>：表示当前的内容的 MIME 类型，是图片还是文本还是二进制数据。</p>
  <p><strong>解析</strong></p>
  <p>客户端发送请求到服务器后，服务器会收到请求的消息体，然后对消息体进行解析，解析出哪是普通表单哪些是附件。</p>
  <p>可能大家马上能想到通过正则或者字符串处理分割出内容，不过这样是行不通的，二进制<code>buffer</code>转化为<code>string</code>,对字符串进行截取后，其索引和字符串是不一致的，所以结果就不会正确，除非上传的就是字符串。</p>
  <p>不过一般情况下不需要自行解析，目前已经有很成熟的三方库可以使用。</p>
  <p>至于如何解析，这个也会占用很大篇幅，后面的文章在详细说。</p>
  <h1 data-id="heading-3">最原始的文件上传</h1>
  <p><strong>使用 form 表单上传文件</strong></p>
  <p>在 <code>ie</code>时代，如果实现一个无刷新的文件上传那可是费老劲了，大部分都是用 iframe 来实现局部刷新或者使用 flash 插件来搞定，在那个时代 ie 就是最好用的浏览器（别无选择）。</p>
  <p><code>DEMO</code></p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3b9b353b4bc7~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p>这种方式上传文件，不需要 js ，而且没有兼容问题，所有浏览器都支持，就是体验很差，导致页面刷新，页面其他数据丢失。</p>
  <p><code>HTML</code></p>
  <pre><code lang="xml" class="hljs language-xml copyable"> <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"http://localhost:8100"</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">"multipart/form-data"</span>&gt;</span>

        选择文件:
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"f1"</span>/&gt;</span> input 必须设置 name 属性，否则数据无法发送<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
            标题：<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"title"</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn-0"</span>&gt;</span>上 传<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>

<span class="copy-code-btn">复制代码</span></code></pre><h1 data-id="heading-4">文件上传接口</h1>
  <p>服务端文件的保存基于现有的库<code>koa-body</code>结合 <code>koa2</code>实现服务端文件的保存和数据的返回。</p>
  <p>在项目开发中，文件上传本身和业务无关，代码基本上都可通用。</p>
  <p>在这里我们使用<code>koa-body</code>库来实现解析和文件的保存。</p>
  <p><code>koa-body</code> 会自动保存文件到系统临时目录下，也可以指定保存的文件路径。</p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/7/16da5a50d29b54b3~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p>然后在后续中间件内得到已保存的文件的信息，再做二次处理。</p>
  <ul>
    <li><code>ctx.request.files.f1</code>   得到文件信息，<code>f1</code>为<code>input file</code> 标签的 <code>name</code></li>
    <li>获得文件的扩展名，重命名文件</li>
  </ul>
  <p><code>NODE</code></p>
  <pre><code lang="ini" class="hljs language-ini copyable">/**
 * 服务入口
 */
var <span class="hljs-attr">http</span> = require(<span class="hljs-string">'http'</span>)<span class="hljs-comment">;</span>
var <span class="hljs-attr">koaStatic</span> = require(<span class="hljs-string">'koa-static'</span>)<span class="hljs-comment">;</span>
var <span class="hljs-attr">path</span> = require(<span class="hljs-string">'path'</span>)<span class="hljs-comment">;</span>
var <span class="hljs-attr">koaBody</span> = require(<span class="hljs-string">'koa-body'</span>)<span class="hljs-comment">;//文件保存库</span>
var <span class="hljs-attr">fs</span> = require(<span class="hljs-string">'fs'</span>)<span class="hljs-comment">;</span>
var <span class="hljs-attr">Koa</span> = require(<span class="hljs-string">'koa2'</span>)<span class="hljs-comment">;</span>

var <span class="hljs-attr">app</span> = new Koa()<span class="hljs-comment">;</span>
var <span class="hljs-attr">port</span> = process.env.PORT || <span class="hljs-string">'8100'</span><span class="hljs-comment">;</span>

var <span class="hljs-attr">uploadHost</span>= `http://localhost:<span class="hljs-variable">${port}</span>/uploads/`<span class="hljs-comment">;</span>

app.use(koaBody({
    formidable: {
        //设置文件的默认保存目录，不设置则保存在系统临时目录下  os
        uploadDir: path.resolve(__dirname, '../static/uploads')
    },
    multipart: true // 开启文件上传，默认是关闭
}))<span class="hljs-comment">;</span>

//开启静态文件访问
app.use(koaStatic(
    path.resolve(__dirname, '../static')
))<span class="hljs-comment">;</span>

//文件二次处理，修改名称
app.use((ctx) =&gt; {
    var <span class="hljs-attr">file</span> = ctx.request.files.f1<span class="hljs-comment">;//得道文件对象</span>
    var <span class="hljs-attr">path</span> = file.path<span class="hljs-comment">;</span>
    var <span class="hljs-attr">fname</span> = file.name<span class="hljs-comment">;//原文件名称</span>
    var <span class="hljs-attr">nextPath</span> = path+fname<span class="hljs-comment">;</span>
    if(file.size&gt;0 &amp;&amp; path){
        //得到扩展名
        var <span class="hljs-attr">extArr</span> = fname.split(<span class="hljs-string">'.'</span>)<span class="hljs-comment">;</span>
        var <span class="hljs-attr">ext</span> = extArr[extArr.length-<span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
        var <span class="hljs-attr">nextPath</span> = path+<span class="hljs-string">'.'</span>+ext<span class="hljs-comment">;</span>
        //重命名文件
        fs.renameSync(path, nextPath)<span class="hljs-comment">;</span>
    }
    //以 json 形式输出上传文件地址
    <span class="hljs-attr">ctx.body</span> = `{
        "fileUrl":"${uploadHost}${nextPath.slice(nextPath.lastIndexOf('/')+1)}"
    }`<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>

/**
 * http server
 */
var <span class="hljs-attr">server</span> = http.createServer(app.callback())<span class="hljs-comment">;</span>
server.listen(port)<span class="hljs-comment">;</span>
console.log('demo1 server start ......   ')<span class="hljs-comment">;</span>
<span class="copy-code-btn">复制代码</span></code></pre><p><code>CODE</code></p>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBigerfe%2Ffe-learn-code%2Ftree%2Fmaster%2Fsrc%2Fupfiles-demo%2Fdemo1" title="https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo1" ref="nofollow noopener noreferrer">github.com/Bigerfe/fe-…</a></p>
  <h1 data-id="heading-5">多文件上传</h1>
  <p>在 <code>ie</code> 时代的多文件上传是需要创建多个 <code>input file</code> 标签，现在 <code>html5</code>只需要一个标签加个属性就搞定了,<code>file</code> 标签开启<code>multiple</code>。</p>
  <p><code>DEMO</code></p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3bc9abab6d30~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p><code>HTML</code></p>
  <pre><code lang="go" class="hljs language-go copyable"><span class="hljs-comment">//设置 multiple属性</span>
&lt;input <span class="hljs-keyword">type</span>=<span class="hljs-string">"file"</span> name=<span class="hljs-string">"f1"</span> multiple/&gt;
<span class="copy-code-btn">复制代码</span></code></pre><p><code>NODE</code></p>
  <p>服务端也需要进行简单的调整，由单文件对象变为多文件数组，然后进行遍历处理。</p>
  <pre><code lang="ini" class="hljs language-ini copyable">//二次处理文件，修改名称
app.use((ctx) =&gt; {

    var <span class="hljs-attr">files</span> = ctx.request.files.f1<span class="hljs-comment">;// 多文件， 得到上传文件的数组</span>
    var <span class="hljs-attr">result</span>=[]<span class="hljs-comment">;</span>

    //遍历处理
    files &amp;&amp; files.forEach(<span class="hljs-attr">item</span>=&gt;{
        var <span class="hljs-attr">path</span> = item.path<span class="hljs-comment">;</span>
        var <span class="hljs-attr">fname</span> = item.name<span class="hljs-comment">;//原文件名称</span>
        var <span class="hljs-attr">nextPath</span> = path + fname<span class="hljs-comment">;</span>
        if (item.size &gt; 0 &amp;&amp; path) {
            //得到扩展名
            var <span class="hljs-attr">extArr</span> = fname.split(<span class="hljs-string">'.'</span>)<span class="hljs-comment">;</span>
            var <span class="hljs-attr">ext</span> = extArr[extArr.length - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
            var <span class="hljs-attr">nextPath</span> = path + <span class="hljs-string">'.'</span> + ext<span class="hljs-comment">;</span>
            //重命名文件
            fs.renameSync(path, nextPath)<span class="hljs-comment">;</span>

            //文件可访问路径放入数组
            result.push(uploadHost+ nextPath.slice(nextPath.lastIndexOf('/') + 1))<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>

    //输出 json 结果
    <span class="hljs-attr">ctx.body</span> = `{
        "fileUrl":${JSON.stringify(result)}
    }`<span class="hljs-comment">;</span>
})
<span class="copy-code-btn">复制代码</span></code></pre><p><code>CODE</code></p>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBigerfe%2Ffe-learn-code%2Ftree%2Fmaster%2Fsrc%2Fupfiles-demo%2Fdemo2" title="https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo2" ref="nofollow noopener noreferrer">github.com/Bigerfe/fe-…</a></p>
  <h1 data-id="heading-6">局部刷新 - iframe</h1>
  <p>这里说的是在 <code>ie</code> 时代的上传文件局部刷新，借助 iframe 实现。</p>
  <p><code>DEMO</code></p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3bde37cca831~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <ul>
    <li>局部刷新</li>
  </ul>
  <p>页面内放一个隐藏的 <code>iframe</code>，或者使用 <code>js</code> 动态创建，指定 <code>form</code> 表单的 <code>target</code> 属性值为<code>iframe</code>标签 的 <code>name</code> 属性值，这样 <code>form</code> 表单的 <code>shubmit</code> 行为的跳转就会在 <code>iframe</code> 内完成，整体页面不会刷新。</p>
  <ul>
    <li>拿到接口数据</li>
  </ul>
  <p>然后为 <code>iframe</code> 添加<code>load</code>事件，得到 <code>iframe</code> 的页面内容，将结果转换为 <code>JSON</code> 对象，这样就拿到了接口的数据</p>
  <p><code>HTML</code></p>
  <pre><code lang="xml" class="hljs language-xml copyable">   <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"temp-iframe"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"temp-iframe"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"display:none;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"temp-iframe"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"http://localhost:8100"</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">"multipart/form-data"</span>&gt;</span>
        选择文件(可多选):
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"f1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"f1"</span> <span class="hljs-attr">multiple</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span> input 必须设置 name 属性，否则数据无法发送<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
            标题：<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"title"</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn-0"</span>&gt;</span>上 传<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">

<span class="hljs-keyword">var</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'temp-iframe'</span>);
iframe.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>,<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
      <span class="hljs-keyword">var</span> result = iframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-property">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerText</span>;
      <span class="hljs-comment">//接口数据转换为 JSON 对象</span>
      <span class="hljs-keyword">var</span> obj = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(result);
      <span class="hljs-keyword">if</span>(obj &amp;&amp; obj.<span class="hljs-property">fileUrl</span>.<span class="hljs-property">length</span>){
          <span class="hljs-title function_">alert</span>(<span class="hljs-string">'上传成功'</span>);

      }
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj);
});


</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="copy-code-btn">复制代码</span></code></pre><p><code>NODE</code></p>
  <p>服务端代码不需要改动，略.</p>
  <p><code>CODE</code></p>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBigerfe%2Ffe-learn-code%2Ftree%2Fmaster%2Fsrc%2Fupfiles-demo%2Fdemo3" title="https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo3" ref="nofollow noopener noreferrer">github.com/Bigerfe/fe-…</a></p>
  <h1 data-id="heading-7">无刷新上传</h1>
  <p>无刷新上传文件肯定要用到<code>XMLHttpRequest</code>,在 <code>ie</code> 时代也有这个对象，单只 支持文本数据的传输，无法用来读取和上传二进制数据。</p>
  <p>现在已然升级到了<code>XMLHttpRequest2</code>，较1版本有非常大的升级，首先就是可以读取和上传二进制数据，可以使用·FormData·对象管理表单数据。</p>
  <p>当然也可使用 <code>fetch</code> 进行上传。</p>
  <p><code>DEMO</code></p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3bf40a6ae554~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p><code>HTML</code></p>
  <pre><code lang="xml" class="hljs language-xml copyable"> <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        选择文件(可多选):
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"f1"</span> <span class="hljs-attr">multiple</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn-submit"</span>&gt;</span>上 传<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="copy-code-btn">复制代码</span></code></pre><p><code>JS xhr</code></p>
  <pre><code lang="xml" class="hljs language-xml copyable">
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitUpload</span>(<span class="hljs-params"></span>) {
        <span class="hljs-comment">//获得文件列表，注意这里不是数组，而是对象</span>
        <span class="hljs-keyword">var</span> fileList = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'f1'</span>).<span class="hljs-property">files</span>;
        <span class="hljs-keyword">if</span>(!fileList.<span class="hljs-property">length</span>){
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请选择文件'</span>);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">var</span> fd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();   <span class="hljs-comment">//构造FormData对象</span>
        fd.<span class="hljs-title function_">append</span>(<span class="hljs-string">'title'</span>, <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'title'</span>).<span class="hljs-property">value</span>);

        <span class="hljs-comment">//多文件上传需要遍历添加到 fromdata 对象</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i =<span class="hljs-number">0</span>;i&lt;fileList.<span class="hljs-property">length</span>;i++){
            fd.<span class="hljs-title function_">append</span>(<span class="hljs-string">'f1'</span>, fileList[i]);<span class="hljs-comment">//支持多文件上传</span>
        }

        <span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();   <span class="hljs-comment">//创建对象</span>
        xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'http://localhost:8100/'</span>, <span class="hljs-literal">true</span>);

        xhr.<span class="hljs-title function_">send</span>(fd);<span class="hljs-comment">//发送时  Content-Type默认就是: multipart/form-data; </span>
        xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'state change'</span>, xhr.<span class="hljs-property">readyState</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> == <span class="hljs-number">4</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> == <span class="hljs-number">200</span>) {
                <span class="hljs-keyword">var</span> obj = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);   <span class="hljs-comment">//返回值</span>
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj);
                <span class="hljs-keyword">if</span>(obj.<span class="hljs-property">fileUrl</span>.<span class="hljs-property">length</span>){
                    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'上传成功'</span>);
                }
            }
        }

    }

    <span class="hljs-comment">//绑定提交事件</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'btn-submit'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,submitUpload);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="copy-code-btn">复制代码</span></code></pre><p><code>JS Fetch</code></p>
  <pre><code lang="ini" class="hljs language-ini copyable">  fetch('http://localhost:8100/', {
            method: 'POST',
            body: fd
        })
            .then(<span class="hljs-attr">response</span> =&gt; response.json())
            .then(<span class="hljs-attr">response</span> =&gt;{
                console.log(response)<span class="hljs-comment">;</span>
                if (response.fileUrl.length) {
                    alert('上传成功')<span class="hljs-comment">;</span>
                }
            } )
            .catch(<span class="hljs-attr">error</span> =&gt; console.error(<span class="hljs-string">'Error:'</span>, error))<span class="hljs-comment">;</span>
<span class="copy-code-btn">复制代码</span></code></pre><p><code>CODE</code></p>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBigerfe%2Ffe-learn-code%2Ftree%2Fmaster%2Fsrc%2Fupfiles-demo%2Fdemo4" title="https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo4" ref="nofollow noopener noreferrer">github.com/Bigerfe/fe-…</a></p>
  <h1 data-id="heading-8">多文件，单进度</h1>
  <p>借助<code>XMLHttpRequest2</code>的能力，实现多个文件或者一个文件的上传进度条的显示。</p>
  <p><code>DEMO</code></p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3bff57634139~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p><code>说明</code></p>
  <ul>
    <li>页面内增加一个用于显示进度的标签 <code>div.progress</code></li>
    <li><code>js</code> 内处理增加进度处理的监听函数<code>xhr.upload.onprogress</code></li>
    <li><code>event.lengthComputable</code>这是一个状态，表示发送的长度有了变化，可计算</li>
    <li><code>event.loaded</code>表示发送了多少字节</li>
    <li><code>event.total</code>表示文件总大小</li>
    <li>根据<code>event.loaded</code>和<code>event.total</code>计算进度，渲染<code>div.progress</code></li>
  </ul>
  <h2 data-id="heading-9">PS 特别提醒</h2>
  <p><code>xhr.upload.onprogress</code>要写在<code>xhr.send</code>方法前面，否则<code>event.lengthComputable</code>状态不会改变，只有在最后一次才能获得，也就是<code>100%</code>的时候.</p>
  <p><code>HTML</code></p>
  <pre><code lang="xml" class="hljs language-xml copyable"> <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>

        选择文件(可多选):
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"f1"</span> <span class="hljs-attr">multiple</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"progress"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"red"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn-submit"</span>&gt;</span>上 传<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="copy-code-btn">复制代码</span></code></pre><p><code>JS</code></p>
  <pre><code lang="ini" class="hljs language-ini copyable">&lt;script&gt;

    function submitUpload() {
        var <span class="hljs-attr">progressSpan</span> = document.getElementById(<span class="hljs-string">'progress'</span>).firstElementChild<span class="hljs-comment">;</span>
        var <span class="hljs-attr">fileList</span> = document.getElementById(<span class="hljs-string">'f1'</span>).files<span class="hljs-comment">;</span>
        <span class="hljs-attr">progressSpan.style.width</span>=<span class="hljs-string">'0'</span><span class="hljs-comment">;</span>
        progressSpan.classList.remove('green')<span class="hljs-comment">;</span>

        if(!fileList.length){
            alert('请选择文件')<span class="hljs-comment">;</span>
            return<span class="hljs-comment">;</span>
        }

        var <span class="hljs-attr">fd</span> = new FormData()<span class="hljs-comment">;   //构造FormData对象</span>
        fd.append('title', document.getElementById('title').value)<span class="hljs-comment">;</span>

        for(var <span class="hljs-attr">i</span> =<span class="hljs-number">0</span><span class="hljs-comment">;i&lt;fileList.length;i++){</span>
            fd.append('f1', fileList<span class="hljs-section">[i]</span>)<span class="hljs-comment">;//支持多文件上传</span>
        }

        var <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;   //创建对象</span>
        xhr.open('POST', 'http://10.70.65.235:8100/', true)<span class="hljs-comment">;</span>

        <span class="hljs-attr">xhr.onreadystatechange</span> = function () {
            console.log('state change', xhr.readyState)<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">xhr.readyState</span> == <span class="hljs-number">4</span>) {
                var <span class="hljs-attr">obj</span> = JSON.parse(xhr.responseText)<span class="hljs-comment">;   //返回值</span>
                console.log(obj)<span class="hljs-comment">;</span>
                if(obj.fileUrl.length){
                    //alert('上传成功')<span class="hljs-comment">;</span>
                }
            }
        }

        <span class="hljs-attr">xhr.onprogress</span>=updateProgress<span class="hljs-comment">;</span>
        <span class="hljs-attr">xhr.upload.onprogress</span> = updateProgress<span class="hljs-comment">;</span>
        function updateProgress(event) {
            console.log(event)<span class="hljs-comment">;</span>
            if (event.lengthComputable) {
                var <span class="hljs-attr">completedPercent</span> = (event.loaded / event.total * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
                <span class="hljs-attr">progressSpan.style.width</span>= completedPercent+<span class="hljs-string">'%'</span><span class="hljs-comment">;</span>
                <span class="hljs-attr">progressSpan.innerHTML</span>=completedPercent+<span class="hljs-string">'%'</span><span class="hljs-comment">;</span>
                if(completedPercent&gt;90){//进度条变色
                    progressSpan.classList.add('green')<span class="hljs-comment">;</span>
                }
                console.log('已上传',completedPercent)<span class="hljs-comment">;</span>
            }
        }
        //注意 send 一定要写在最下面，否则 onprogress 只会执行最后一次 也就是100%的时候
        xhr.send(fd)<span class="hljs-comment">;//发送时  Content-Type默认就是: multipart/form-data; </span>
    }
    //绑定提交事件
    document.getElementById('btn-submit').addEventListener('click',submitUpload)<span class="hljs-comment">;</span>


&lt;/script&gt;
<span class="copy-code-btn">复制代码</span></code></pre><p><code>CODE</code></p>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBigerfe%2Ffe-learn-code%2Ftree%2Fmaster%2Fsrc%2Fupfiles-demo%2Fdemo5" title="https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo5" ref="nofollow noopener noreferrer">github.com/Bigerfe/fe-…</a></p>
  <h1 data-id="heading-10">多文件上传+预览+取消</h1>
  <p>上一个栗子的多文件上传只有一个进度条，有些需求可能会不大一样，需要观察到每个文件的上传进度，并且可以终止上传。</p>
  <p><code>DEMO</code></p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3c15b6fe32aa~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p><code>说明</code></p>
  <ul>
    <li>为了预览的需要，我们这里选择上传图片文件，其他类型的也一样，只是预览不方便</li>
    <li>页面内增加一个多图预览的容器<code>div.img-box</code></li>
    <li>根据选择的文件信息动态创建所属的预览区域和进度条以及取消按钮</li>
    <li>为取消按钮绑定事件，调用<code>xhr.abort();</code>终止上传</li>
    <li>使用<code>window.URL.createObjectURL</code>预览图片，在图片加载成功后需要清除使用的内存<code>window.URL.revokeObjectURL(this.src);</code></li>
  </ul>
  <p><code>HTML</code></p>
  <pre><code lang="xml" class="hljs language-xml copyable"> <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        选择文件(可多选):
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"addfile"</span>&gt;</span>添加文件
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"f1"</span> <span class="hljs-attr">multiple</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"img-box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn-submit"</span>&gt;</span>上 传<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="copy-code-btn">复制代码</span></code></pre><p><code>JS</code></p>
  <pre><code lang="ini" class="hljs language-ini copyable">&lt;script&gt;
    //更改网络 为慢3g，就可以比较明显的看到进度条了
    var <span class="hljs-attr">fileMaxCount</span>=<span class="hljs-number">6</span><span class="hljs-comment">;</span>
    var <span class="hljs-attr">imgBox</span> =document.getElementsByClassName(<span class="hljs-string">'img-box'</span>)[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
    var <span class="hljs-attr">willUploadFile</span>=[]<span class="hljs-comment">;//保存待上传的文件以及相关附属信息</span>
    document.getElementById('f1').addEventListener('change',function (e) {
        var <span class="hljs-attr">fileList</span> = document.getElementById(<span class="hljs-string">'f1'</span>).files<span class="hljs-comment">;</span>

        if (willUploadFile.length &gt; fileMaxCount || fileList.length&gt;fileMaxCount || (willUploadFile.length+ fileList.length&gt;fileMaxCount)) {
            alert('最多只能上传' + fileMaxCount + '张图')<span class="hljs-comment">;</span>
            return<span class="hljs-comment">;</span>
        }
        for (var <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; fileList.length; i++) {</span>
            var <span class="hljs-attr">f</span> = fileList[i]<span class="hljs-comment">;//先预览图片</span>
            var <span class="hljs-attr">img</span> = document.createElement(<span class="hljs-string">'img'</span>)<span class="hljs-comment">;</span>
            var <span class="hljs-attr">item</span> = document.createElement(<span class="hljs-string">'div'</span>)<span class="hljs-comment">;</span>
            var <span class="hljs-attr">progress</span> = document.createElement(<span class="hljs-string">'div'</span>)<span class="hljs-comment">;</span>
            <span class="hljs-attr">progress.className</span>=<span class="hljs-string">'progress'</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">progress.innerHTML</span> = <span class="hljs-string">'&lt;span class="red"&gt;&lt;/span&gt;&lt;button type="button"&gt;Abort&lt;/button&gt;'</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">item.className</span>=<span class="hljs-string">'item'</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">img.src</span> = window.URL.createObjectURL(f)<span class="hljs-comment">;</span>
            <span class="hljs-attr">img.onload</span> = function () {
                //显示要是否这块儿内存
                window.URL.revokeObjectURL(this.src)<span class="hljs-comment">;</span>
            }

            item.appendChild(img)<span class="hljs-comment">;</span>
            item.appendChild(progress)<span class="hljs-comment">;</span>
            imgBox.appendChild(item)<span class="hljs-comment">;</span>

            willUploadFile.push({
                file:f,
                item,
                progress
            })<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>


    function xhrSend({file, progress}) {

        var <span class="hljs-attr">progressSpan</span> = progress.firstElementChild<span class="hljs-comment">;</span>
        var <span class="hljs-attr">btnCancel</span> = progress.getElementsByTagName(<span class="hljs-string">'button'</span>)[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
        var <span class="hljs-attr">abortFn</span>=function(){
              if(xhr &amp;&amp; xhr.readyState!==4){
               //取消上传
               xhr.abort()<span class="hljs-comment">;</span>
           }
        }
        btnCancel.removeEventListener('click',abortFn)<span class="hljs-comment">;</span>
        btnCancel.addEventListener('click',abortFn)<span class="hljs-comment">;</span>

        <span class="hljs-attr">progressSpan.style.width</span>=<span class="hljs-string">'0'</span><span class="hljs-comment">;</span>
        progressSpan.classList.remove('green')<span class="hljs-comment">;</span>

        var <span class="hljs-attr">fd</span> = new FormData()<span class="hljs-comment">;   //构造FormData对象</span>
        fd.append('f1',file)<span class="hljs-comment">;</span>

        var <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;   //创建对象</span>
        xhr.open('POST', 'http://localhost:8100/', true)<span class="hljs-comment">;</span>

        <span class="hljs-attr">xhr.onreadystatechange</span> = function () {
            console.log('state change', xhr.readyState)<span class="hljs-comment">;</span>
            //调用 abort 后，state 立即变成了4,并不会变成0
            //增加自定义属性  xhr.uploaded
            if (<span class="hljs-attr">xhr.readyState</span> == <span class="hljs-number">4</span> &amp;&amp;  xhr.uploaded) {
                var <span class="hljs-attr">obj</span> = JSON.parse(xhr.responseText)<span class="hljs-comment">;   //返回值</span>
                console.log(obj)<span class="hljs-comment">;</span>
                if(obj.fileUrl.length){
                    //alert('上传成功')<span class="hljs-comment">;</span>
                }
            }
        }

        <span class="hljs-attr">xhr.onprogress</span>=updateProgress<span class="hljs-comment">;</span>
        <span class="hljs-attr">xhr.upload.onprogress</span> = updateProgress<span class="hljs-comment">;</span>
        function updateProgress(event) {
            if (event.lengthComputable) {
                var <span class="hljs-attr">completedPercent</span> = (event.loaded / event.total * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
                <span class="hljs-attr">progressSpan.style.width</span>= completedPercent+<span class="hljs-string">'%'</span><span class="hljs-comment">;</span>
                <span class="hljs-attr">progressSpan.innerHTML</span>=completedPercent+<span class="hljs-string">'%'</span><span class="hljs-comment">;</span>
                if(completedPercent&gt;90){//进度条变色
                    progressSpan.classList.add('green')<span class="hljs-comment">;</span>
                }
                if(completedPercent&gt;=100){
                    <span class="hljs-attr">xhr.uploaded</span>=<span class="hljs-literal">true</span><span class="hljs-comment">;</span>
                }
                console.log('已上传',completedPercent)<span class="hljs-comment">;</span>
            }
        }
        //注意 send 一定要写在最下面，否则 onprogress 只会执行最后一次 也就是100%的时候
        xhr.send(fd)<span class="hljs-comment">;//发送时  Content-Type默认就是: multipart/form-data; </span>
        return xhr<span class="hljs-comment">;</span>
    }

    //文件上传
    function submitUpload(willFiles) {
        if(!willFiles.length){
            return<span class="hljs-comment">;</span>
        }
        //遍历文件信息进行上传
        willFiles.forEach(function (item) {
             xhrSend({
                 file:item.file,
                 progress:item.progress
             })<span class="hljs-comment">;</span>
        })<span class="hljs-comment">;</span>
    }
    //绑定提交事件
    document.getElementById('btn-submit').addEventListener('click',function () {
        submitUpload(willUploadFile)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>

&lt;/script&gt;
<span class="copy-code-btn">复制代码</span></code></pre><h2 data-id="heading-11">问题1</h2>
  <p>这里没有做上传的并发控制，可以通过控制同时可上传文件的个数（这里控制为最多6个）或者上传的时候做好并发处理，也就是同时只能上传 X 个文件。</p>
  <h2 data-id="heading-12">问题2</h2>
  <p>在测试过程中，取消请求的方法<code>xhr.abort()</code>调用后，<code>xhr.readyState</code>会立即变为<code>4</code>,而不是<code>0</code>，所以这里需要做容错处理。</p>
  <p>MDN 上说是0.</p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd29041bd33cdd~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p>如果大家有不同的结果，欢迎留言。</p>
  <p><code>CODE</code></p>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBigerfe%2Ffe-learn-code%2Ftree%2Fmaster%2Fsrc%2Fupfiles-demo%2Fdemo11" title="https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo11" ref="nofollow noopener noreferrer">github.com/Bigerfe/fe-…</a></p>
  <h1 data-id="heading-13">拖拽上传</h1>
  <p><code>html5</code>的出现，让拖拽上传交互成为可能，现在这样的体验也屡见不鲜。</p>
  <p><code>DEMO</code></p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3c296abb9562~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p><code>说明</code></p>
  <ul>
    <li>定义一个允许拖放文件的区域<code>div.drop-box</code></li>
    <li>取消<code>drop</code> 事件的默认行为<code>e.preventDefault();</code>，不然浏览器会直接打开文件</li>
    <li>为拖拽区域绑定事件,鼠标在拖拽区域上 <code>dragover</code>, 鼠标离开拖拽区域<code>dragleave</code>, 在拖拽区域上释放文件<code>drop</code></li>
    <li><code>drop</code>事件内获得文件信息<code>e.dataTransfer.files</code></li>
  </ul>
  <p><code>HTML</code></p>
  <pre><code lang="bash" class="hljs language-bash copyable"> &lt;div class=<span class="hljs-string">"drop-box"</span> <span class="hljs-built_in">id</span>=<span class="hljs-string">"drop-box"</span>&gt;
       拖动文件到这里,开始上传
    &lt;/div&gt;

    &lt;button <span class="hljs-built_in">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-built_in">id</span>=<span class="hljs-string">"btn-submit"</span>&gt;上 传&lt;/button&gt;
<span class="copy-code-btn">复制代码</span></code></pre><p><code>JS</code></p>
  <pre><code lang="xml" class="hljs language-xml copyable"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">

    <span class="hljs-keyword">var</span> box = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'drop-box'</span>);

    <span class="hljs-comment">//禁用浏览器的拖放默认行为</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'drop'</span>,<span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'document drog'</span>);
        e.<span class="hljs-title function_">preventDefault</span>();
    });

    <span class="hljs-comment">//设置拖拽事件</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">openDropEvent</span>(<span class="hljs-params"></span>) {
        box.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"dragover"</span>,<span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'elemenet dragover'</span>);
             box.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'over'</span>);
               e.<span class="hljs-title function_">preventDefault</span>();
        });
         box.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"dragleave"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'elemenet dragleave'</span>);
            box.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'over'</span>);
              e.<span class="hljs-title function_">preventDefault</span>();
        });

        box.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"drop"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
            e.<span class="hljs-title function_">preventDefault</span>(); <span class="hljs-comment">//取消浏览器默认拖拽效果</span>

            <span class="hljs-keyword">var</span> fileList = e.<span class="hljs-property">dataTransfer</span>.<span class="hljs-property">files</span>; <span class="hljs-comment">//获取拖拽中的文件对象</span>
            <span class="hljs-keyword">var</span> len=fileList.<span class="hljs-property">length</span>;<span class="hljs-comment">//用来获取文件的长度（其实是获得文件数量）</span>

            <span class="hljs-comment">//检测是否是拖拽文件到页面的操作</span>
            <span class="hljs-keyword">if</span> (!len) {
                box.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'over'</span>);
                <span class="hljs-keyword">return</span>;
            }

            box.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'over'</span>);

            <span class="hljs-variable language_">window</span>.<span class="hljs-property">willUploadFileList</span>=fileList;

        }, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-title function_">openDropEvent</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitUpload</span>(<span class="hljs-params"></span>) {

        <span class="hljs-keyword">var</span> fileList = <span class="hljs-variable language_">window</span>.<span class="hljs-property">willUploadFileList</span>||[];
        <span class="hljs-keyword">if</span>(!fileList.<span class="hljs-property">length</span>){
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请选择文件'</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">var</span> fd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();   <span class="hljs-comment">//构造FormData对象</span>

        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i =<span class="hljs-number">0</span>;i&lt;fileList.<span class="hljs-property">length</span>;i++){
            fd.<span class="hljs-title function_">append</span>(<span class="hljs-string">'f1'</span>, fileList[i]);<span class="hljs-comment">//支持多文件上传</span>
        }

        <span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();   <span class="hljs-comment">//创建对象</span>
        xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'http://localhost:8100/'</span>, <span class="hljs-literal">true</span>);
        xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
            <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> == <span class="hljs-number">4</span>) {
                <span class="hljs-keyword">var</span> obj = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);   <span class="hljs-comment">//返回值</span>
                <span class="hljs-keyword">if</span>(obj.<span class="hljs-property">fileUrl</span>.<span class="hljs-property">length</span>){
                    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'上传成功'</span>);
                }
            }
        }
        xhr.<span class="hljs-title function_">send</span>(fd);<span class="hljs-comment">//发送</span>
    }
    <span class="hljs-comment">//绑定提交事件</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'btn-submit'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>,submitUpload);

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="copy-code-btn">复制代码</span></code></pre><p><code>CODE</code></p>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBigerfe%2Ffe-learn-code%2Ftree%2Fmaster%2Fsrc%2Fupfiles-demo%2Fdemo7" title="https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo7" ref="nofollow noopener noreferrer">github.com/Bigerfe/fe-…</a></p>
  <h1 data-id="heading-14">剪贴板上传</h1>
  <p>掘金的写文编辑器是支持粘贴上传图片的，比如我从磁盘粘贴或者从网页上右键复制图片。</p>
  <p><code>DEMO</code></p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3c3dc32af3fc~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p><code>说明</code></p>
  <ul>
    <li>页面内增加一个可编辑的编辑区域<code>div.editor-box</code>,开启<code>contenteditable</code></li>
    <li>为<code>div.editor-box</code>绑定<code>paste</code>事件</li>
    <li>处理<code>paste</code> 事件，从<code>event.clipboardData || window.clipboardData</code>获得数据</li>
    <li>将数据转换为文件<code>items[i].getAsFile()</code></li>
    <li>实现在编辑区域的光标处插入内容 <code>insertNodeToEditor</code> 方法</li>
  </ul>
  <h2 data-id="heading-15">问题1</h2>
  <p>测试中发现复制多个文件无效，只有最后一个文件上传，在掘金的编辑器里也同样存在，在坐有知道原因的可以留言说下。</p>
  <h2 data-id="heading-16">问题2</h2>
  <p><code>mac</code>系统可以支持从磁盘复制文件后上传，<code>windows</code> 系统测试未通过，剪贴板的数据未拿到。</p>
  <p><code>HTML</code></p>
  <pre><code lang="bash" class="hljs language-bash copyable"> &lt;div class=<span class="hljs-string">"editor-box"</span> <span class="hljs-built_in">id</span>=<span class="hljs-string">"editor-box"</span> contenteditable=<span class="hljs-string">"true"</span> &gt;
       可以直接粘贴图片到这里直接上传
 &lt;/div&gt;
<span class="copy-code-btn">复制代码</span></code></pre><p><code>JS</code></p>
  <pre><code lang="ini" class="hljs language-ini copyable"> //光标处插入 dom 节点
    function  insertNodeToEditor(editor,ele) {
        //插入dom 节点
        var range<span class="hljs-comment">;//记录光标位置对象</span>
        var <span class="hljs-attr">node</span> = window.getSelection().anchorNode<span class="hljs-comment">;</span>
        // 这里判断是做是否有光标判断，因为弹出框默认是没有的
        if (node != null) {
            <span class="hljs-attr">range</span> = window.getSelection().getRangeAt(<span class="hljs-number">0</span>)<span class="hljs-comment">;// 获取光标起始位置</span>
            range.insertNode(ele)<span class="hljs-comment">;// 在光标位置插入该对象</span>
        } else {
            editor.append(ele)<span class="hljs-comment">;</span>
        }
    }

    var <span class="hljs-attr">box</span> = document.getElementById(<span class="hljs-string">'editor-box'</span>)<span class="hljs-comment">;</span>
    //绑定paste事件
    box.addEventListener('paste',function (event) {
        var <span class="hljs-attr">data</span> = (event.clipboardData || window.clipboardData)<span class="hljs-comment">;</span>

        var <span class="hljs-attr">items</span> = data.items<span class="hljs-comment">;</span>
        var <span class="hljs-attr">fileList</span> = []<span class="hljs-comment">;//存储文件数据</span>
        if (items &amp;&amp; items.length) {
            // 检索剪切板items
            for (var <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; items.length; i++) {</span>
                console.log(items<span class="hljs-section">[i]</span>.getAsFile())<span class="hljs-comment">;</span>
                fileList.push(items<span class="hljs-section">[i]</span>.getAsFile())<span class="hljs-comment">;</span>
            }
        }

        <span class="hljs-attr">window.willUploadFileList</span> = fileList<span class="hljs-comment">;</span>
        event.preventDefault()<span class="hljs-comment">;//阻止默认行为</span>

        submitUpload()<span class="hljs-comment">;</span>
    })<span class="hljs-comment">; </span>

    function submitUpload() {

        var <span class="hljs-attr">fileList</span> = window.willUploadFileList||[]<span class="hljs-comment">;</span>
        var <span class="hljs-attr">fd</span> = new FormData()<span class="hljs-comment">;   //构造FormData对象</span>
        for(var <span class="hljs-attr">i</span> =<span class="hljs-number">0</span><span class="hljs-comment">;i&lt;fileList.length;i++){</span>
            fd.append('f1', fileList<span class="hljs-section">[i]</span>)<span class="hljs-comment">;//支持多文件上传</span>
        }
        var <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;   //创建对象</span>
        xhr.open('POST', 'http://localhost:8100/', true)<span class="hljs-comment">;</span>
        <span class="hljs-attr">xhr.onreadystatechange</span> = function () {
            if (<span class="hljs-attr">xhr.readyState</span> === <span class="hljs-number">4</span>) {
                var <span class="hljs-attr">obj</span> = JSON.parse(xhr.responseText)<span class="hljs-comment">;   //返回值</span>
                console.log(obj)<span class="hljs-comment">;</span>
                if(obj.fileUrl.length){
                    var <span class="hljs-attr">img</span> = document.createElement(<span class="hljs-string">'img'</span>)<span class="hljs-comment">;</span>
                    <span class="hljs-attr">img.src</span>= obj.fileUrl[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
                    <span class="hljs-attr">img.style.width</span>=<span class="hljs-string">'100px'</span><span class="hljs-comment">;</span>
                    insertNodeToEditor(box,img)<span class="hljs-comment">;</span>
                   // alert('上传成功')<span class="hljs-comment">;</span>
                }
            }
        }

        xhr.send(fd)<span class="hljs-comment">;//发送</span>
    }

<span class="copy-code-btn">复制代码</span></code></pre><p><code>CODE</code></p>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBigerfe%2Ffe-learn-code%2Fblob%2Fmaster%2Fsrc%2Fupfiles-demo%2Fdemo8%2F" title="https://github.com/Bigerfe/fe-learn-code/blob/master/src/upfiles-demo/demo8/" ref="nofollow noopener noreferrer">github.com/Bigerfe/fe-…</a></p>
  <h1 data-id="heading-17">大文件上传-分片</h1>
  <p>在 <code>ie</code> 时代由于无法使用<code>xhr</code>上传二进制数据，上传大文件需要借助浏览器插件来完成。
    现在来看实现大文件上传简直soeasy。</p>
  <p>如果太大的文件，比如一个视频1g 2g那么大，直接采用上面的栗子中的方法上传可能会出链接现超时的情况，而且也会超过服务端允许上传文件的大小限制，所以解决这个问题我们可以将文件进行分片上传，每次只上传很小的一部分 比如2M。</p>
  <p><code>DEMO</code></p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3e61dd505d27~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3c562bd4c801~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p><code>说明</code></p>
  <p>相信大家都对<code>Blob</code> 对象有所了解，它表示原始数据,也就是二进制数据，同时提供了对数据截取的方法<code>slice</code>,而 <code>File</code> 继承了<code>Blob</code>的功能，所以可以直接使用此方法对数据进行分段截图。</p>
  <ul>
    <li>把大文件进行分段 比如2M，发送到服务器携带一个标志，暂时用当前的时间戳，用于标识一个完整的文件</li>
    <li>服务端保存各段文件</li>
    <li>浏览器端所有分片上传完成，发送给服务端一个合并文件的请求</li>
    <li>服务端根据文件标识、类型、各分片顺序进行文件合并</li>
    <li>删除分片文件</li>
  </ul>
  <p><code>HTML</code></p>
  <p>代码略，只需要一个 <code>input file</code> 标签。</p>
  <p><code>JS</code></p>
  <pre><code lang="ini" class="hljs language-ini copyable">   //分片逻辑  像操作字符串一样

    var <span class="hljs-attr">start</span>=<span class="hljs-number">0</span>,end=<span class="hljs-number">0</span><span class="hljs-comment">;</span>
    while (true) {
        end+=chunkSize<span class="hljs-comment">;</span>
        var <span class="hljs-attr">blob</span> = file.slice(start,end)<span class="hljs-comment">;</span>
        start+=chunkSize<span class="hljs-comment">;</span>

        if(!blob.size){//截取的数据为空 则结束
            //拆分结束
            break<span class="hljs-comment">;</span>
        }

        chunks.push(blob)<span class="hljs-comment">;//保存分段数据</span>
    }

&lt;script&gt;
    function submitUpload() {
        var <span class="hljs-attr">chunkSize</span>=<span class="hljs-number">2</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span><span class="hljs-comment">;//分片大小 2M</span>
        var <span class="hljs-attr">file</span> = document.getElementById(<span class="hljs-string">'f1'</span>).files[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
        var <span class="hljs-attr">chunks</span>=[], //保存分片数据
         <span class="hljs-attr">token</span> = (+ new Date()),//时间戳
         <span class="hljs-attr">name</span> =file.name,chunkCount=<span class="hljs-number">0</span>,sendChunkCount=<span class="hljs-number">0</span><span class="hljs-comment">;</span>

        //拆分文件 像操作字符串一样
        if(file.size&gt;chunkSize){
            //拆分文件
            var <span class="hljs-attr">start</span>=<span class="hljs-number">0</span>,end=<span class="hljs-number">0</span><span class="hljs-comment">;</span>
            while (true) {
                end+=chunkSize<span class="hljs-comment">;</span>
                var <span class="hljs-attr">blob</span> = file.slice(start,end)<span class="hljs-comment">;</span>
                start+=chunkSize<span class="hljs-comment">;</span>

                if(!blob.size){//截取的数据为空 则结束
                    //拆分结束
                    break<span class="hljs-comment">;</span>
                }

                chunks.push(blob)<span class="hljs-comment">;//保存分段数据</span>
            }
        }else{
            chunks.push(file.slice(0))<span class="hljs-comment">;</span>
        }

        <span class="hljs-attr">chunkCount</span>=chunks.length<span class="hljs-comment">;//分片的个数 </span>

        //没有做并发限制，较大文件导致并发过多，tcp 链接被占光 ，需要做下并发控制，比如只有4个在请求在发送

        for(var <span class="hljs-attr">i</span>=<span class="hljs-number">0</span><span class="hljs-comment">;i&lt; chunkCount;i++){</span>
            var <span class="hljs-attr">fd</span> = new FormData()<span class="hljs-comment">;   //构造FormData对象</span>
            fd.append('token', token)<span class="hljs-comment">;</span>
            fd.append('f1', chunks<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
            fd.append('index', i)<span class="hljs-comment">;</span>
            xhrSend(fd,function () {
                sendChunkCount+=1<span class="hljs-comment">;</span>
                if(<span class="hljs-attr">sendChunkCount</span>===chunkCount){//上传完成，发送合并请求
                    console.log('上传完成，发送合并请求')<span class="hljs-comment">;</span>
                    var <span class="hljs-attr">formD</span> = new FormData()<span class="hljs-comment">;</span>
                    formD.append('type','merge')<span class="hljs-comment">;</span>
                    formD.append('token',token)<span class="hljs-comment">;</span>
                    formD.append('chunkCount',chunkCount)<span class="hljs-comment">;</span>
                    formD.append('filename',name)<span class="hljs-comment">;</span>
                    xhrSend(formD)<span class="hljs-comment">;</span>
                }
            })<span class="hljs-comment">;</span>
        }
    }

    function xhrSend(fd,cb) {

        var <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;   //创建对象</span>
        xhr.open('POST', 'http://localhost:8100/', true)<span class="hljs-comment">;</span>
        <span class="hljs-attr">xhr.onreadystatechange</span> = function () {
            console.log('state change', xhr.readyState)<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">xhr.readyState</span> == <span class="hljs-number">4</span>) {
                console.log(xhr.responseText)<span class="hljs-comment">;</span>
                cb &amp;&amp; cb()<span class="hljs-comment">;</span>
            }
        }
        xhr.send(fd)<span class="hljs-comment">;//发送</span>
    }

    //绑定提交事件
    document.getElementById('btn-submit').addEventListener('click',submitUpload)<span class="hljs-comment">;</span>
&lt;/script&gt;

<span class="copy-code-btn">复制代码</span></code></pre><p><code>NODE</code></p>
  <p>服务端需要做一些改动，保存分片文件、合并分段文件、删除分段文件。</p>
  <p><strong>PS</strong></p>
  <p>合并文件这里使用 <code>stream pipe</code> 实现，这样更节省内存，边读边写入，占用内存更小，效率更高，代码见<code>fnMergeFile</code>方法。</p>
  <pre><code lang="ini" class="hljs language-ini copyable">//二次处理文件，修改名称
app.use((ctx) =&gt; {
    var <span class="hljs-attr">body</span> = ctx.request.body<span class="hljs-comment">;</span>
    var <span class="hljs-attr">files</span> = ctx.request.files ? ctx.request.files.f1:[]<span class="hljs-comment">;//得到上传文件的数组</span>
    var <span class="hljs-attr">result</span>=[]<span class="hljs-comment">;</span>
    var <span class="hljs-attr">fileToken</span> = ctx.request.body.token<span class="hljs-comment">;// 文件标识</span>
    var <span class="hljs-attr">fileIndex</span>=ctx.request.body.index<span class="hljs-comment">;//文件顺序</span>

    if(files &amp;&amp;  !Array.isArray(files)){//单文件上传容错
        <span class="hljs-attr">files</span>=[files]<span class="hljs-comment">;</span>
    }

    files &amp;&amp; files.forEach(<span class="hljs-attr">item</span>=&gt;{
        var <span class="hljs-attr">path</span> = item.path<span class="hljs-comment">;</span>
        var <span class="hljs-attr">fname</span> = item.name<span class="hljs-comment">;//原文件名称</span>
        var <span class="hljs-attr">nextPath</span> = path.slice(<span class="hljs-number">0</span>, path.lastIndexOf(<span class="hljs-string">'/'</span>) + <span class="hljs-number">1</span>) + fileIndex + <span class="hljs-string">'-'</span> + fileToken<span class="hljs-comment">;</span>
        if (item.size &gt; 0 &amp;&amp; path) {
            //得到扩展名
            var <span class="hljs-attr">extArr</span> = fname.split(<span class="hljs-string">'.'</span>)<span class="hljs-comment">;</span>
            var <span class="hljs-attr">ext</span> = extArr[extArr.length - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
            //var <span class="hljs-attr">nextPath</span> = path + <span class="hljs-string">'.'</span> + ext<span class="hljs-comment">;</span>
            //重命名文件
            fs.renameSync(path, nextPath)<span class="hljs-comment">;</span>
            result.push(uploadHost+nextPath.slice(nextPath.lastIndexOf('/') + 1))<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>

    if(<span class="hljs-attr">body.type</span>===<span class="hljs-string">'merge'</span>){//合并分片文件
        var <span class="hljs-attr">filename</span> = body.filename,
        <span class="hljs-attr">chunkCount</span> = body.chunkCount,
            <span class="hljs-attr">folder</span> = path.resolve(__dirname, <span class="hljs-string">'../static/uploads'</span>)+<span class="hljs-string">'/'</span><span class="hljs-comment">;</span>

        var <span class="hljs-attr">writeStream</span> = fs.createWriteStream(`<span class="hljs-variable">${folder}</span><span class="hljs-variable">${filename}</span>`)<span class="hljs-comment">;</span>

        var <span class="hljs-attr">cindex</span>=<span class="hljs-number">0</span><span class="hljs-comment">;</span>
        //合并文件
        function fnMergeFile(){
            var <span class="hljs-attr">fname</span> = `<span class="hljs-variable">${folder}</span><span class="hljs-variable">${cindex}</span>-<span class="hljs-variable">${fileToken}</span>`<span class="hljs-comment">;</span>
            var <span class="hljs-attr">readStream</span> = fs.createReadStream(fname)<span class="hljs-comment">;</span>
            readStream.pipe(writeStream, { end: false })<span class="hljs-comment">;</span>
            readStream.on("end", function () {
                fs.unlink(fname, function (err) {
                    if (err) {
                        throw err<span class="hljs-comment">;</span>
                    }
                })<span class="hljs-comment">;</span>
                if (cindex+1 &lt; chunkCount){
                    cindex += 1<span class="hljs-comment">;</span>
                    fnMergeFile()<span class="hljs-comment">;</span>
                }
            })<span class="hljs-comment">;</span>
        }
        fnMergeFile()<span class="hljs-comment">;</span>
        <span class="hljs-attr">ctx.body</span>=<span class="hljs-string">'merge ok 200'</span><span class="hljs-comment">;</span>
    }

})<span class="hljs-comment">;</span>
<span class="copy-code-btn">复制代码</span></code></pre><p><code>CODE</code></p>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBigerfe%2Ffe-learn-code%2Ftree%2Fmaster%2Fsrc%2Fupfiles-demo%2Fdemo12" title="https://github.com/Bigerfe/fe-learn-code/tree/master/src/upfiles-demo/demo12" ref="nofollow noopener noreferrer">github.com/Bigerfe/fe-…</a></p>
  <h1 data-id="heading-18">大文件上传-断点续传</h1>
  <p>在上面我们实现了大文件的分片上传，解决了大文件上传超时和服务器的限制。</p>
  <p>但是仍然不够完美，大文件上传并不是短时间内就上传完成，如果期间断网，页面刷新了仍然需要重头上传,这种时间的浪费怎么能忍？</p>
  <p>所以我们实现断点续传，已上传的部分跳过，只传未上传的部分。</p>
  <h2 data-id="heading-19">方法1</h2>
  <p>在上面我们实现了文件分片上传和最终的合并，现在要做的就是如何检测这些分片，不再重新上传即可。
    这里我们可以在本地进行保存已上传成功的分片，重新上传的时候使用<code>spark-md5</code>来生成文件 hash，区分此文件是否已上传。</p>
  <ul>
    <li>为每个分段生成 hash 值，使用  <code>spark-md5</code>  库</li>
    <li>将上传成功的分段信息保存到本地</li>
    <li>重新上传时，进行和本地分段 hash 值的对比，如果相同的话则跳过，继续下一个分段的上传</li>
  </ul>
  <p><strong>PS</strong></p>
  <p>生成 hash 过程肯定也会耗费资源，但是和重新上传相比可以忽略不计了。</p>
  <p><code>DEMO</code></p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3c6f659bcdb1~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure>
  <figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/10/16/16dd3c6f65c598bd~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p><code>HTML</code></p>
  <pre><code lang="bash" class="hljs copyable">代码略
<span class="copy-code-btn">复制代码</span></code></pre><p><code>JS</code></p>
  <p>模拟分段保存，本地保存到<code>localStorage</code></p>
  <pre><code lang="javascript" class="hljs language-javascript copyable">
    <span class="hljs-comment">//获得本地缓存的数据</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUploadedFromStorage</span>(<span class="hljs-params"></span>){
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>( <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(saveChunkKey) || <span class="hljs-string">"{}"</span>);
    }

    <span class="hljs-comment">//写入缓存</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">setUploadedToStorage</span>(<span class="hljs-params">index</span>) {
        <span class="hljs-keyword">var</span> obj =  <span class="hljs-title function_">getUploadedFromStorage</span>();
        obj[index]=<span class="hljs-literal">true</span>;
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(saveChunkKey, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj) );
    }

    <span class="hljs-comment">//分段对比</span>

    <span class="hljs-keyword">var</span> uploadedInfo = <span class="hljs-title function_">getUploadedFromStorage</span>();<span class="hljs-comment">//获得已上传的分段信息</span>

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt; chunkCount;i++){
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'index'</span>,i, uploadedInfo[i]?<span class="hljs-string">'已上传过'</span>:<span class="hljs-string">'未上传'</span>);

            <span class="hljs-keyword">if</span>(uploadedInfo[i]){<span class="hljs-comment">//对比分段</span>
                sendChunkCount=i+<span class="hljs-number">1</span>;<span class="hljs-comment">//记录已上传的索引</span>
                <span class="hljs-keyword">continue</span>;<span class="hljs-comment">//如果已上传则跳过</span>
            }
            <span class="hljs-keyword">var</span> fd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();   <span class="hljs-comment">//构造FormData对象</span>
            fd.<span class="hljs-title function_">append</span>(<span class="hljs-string">'token'</span>, token);
            fd.<span class="hljs-title function_">append</span>(<span class="hljs-string">'f1'</span>, chunks[i]);
            fd.<span class="hljs-title function_">append</span>(<span class="hljs-string">'index'</span>, i);

           (<span class="hljs-keyword">function</span> (<span class="hljs-params">index</span>) {
                    <span class="hljs-title function_">xhrSend</span>(fd, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
                    sendChunkCount += <span class="hljs-number">1</span>;
                    <span class="hljs-comment">//将成功信息保存到本地</span>
                    <span class="hljs-title function_">setUploadedToStorage</span>(index);
                    <span class="hljs-keyword">if</span> (sendChunkCount === chunkCount) {
                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'上传完成，发送合并请求'</span>);
                        <span class="hljs-keyword">var</span> formD = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
                        formD.<span class="hljs-title function_">append</span>(<span class="hljs-string">'type'</span>, <span class="hljs-string">'merge'</span>);
                        formD.<span class="hljs-title function_">append</span>(<span class="hljs-string">'token'</span>, token);
                        formD.<span class="hljs-title function_">append</span>(<span class="hljs-string">'chunkCount'</span>, chunkCount);
                        formD.<span class="hljs-title function_">append</span>(<span class="hljs-string">'filename'</span>, name);
                        <span class="hljs-title function_">xhrSend</span>(formD);
                    }
                });
            })(i);
    }

<span class="copy-code-btn">复制代码</span></code></pre><h2 data-id="heading-20">方法2</h2>
  <p>为什么还有方法2呢，正常情况下方法1没问题，但是需要将分片信息保存在客户端，保存在客户端是最不保险的，说不定出现各种神奇的幺蛾子。</p>
  <p>所以这里有一个更完善的实现，只提供思路，代码就不写了，也是基于上面的实现，只是服务端需要增加一个接口。</p>
  <p>基于上面一个栗子进行改进，服务端已保存了部分片段，客户端上传前需要从服务端获取已上传的分片信息（上面是保存在了本地浏览器），本地对比每个分片的 hash 值，跳过已上传的部分，只传未上传的分片。</p>
  <p>方法1是从本地获取分片信息,这里只需要将此方法的能力改为从服务端获取分片信息就行了。</p>
  <pre><code lang="diff" class="hljs language-diff copyable"><span class="hljs-deletion">-getUploadedFromStorage</span>
<span class="hljs-addition">+getUploadedFromServer(fileHash)</span>
<span class="copy-code-btn">复制代码</span></code></pre><p>另外服务端增加一个获取分片的接口供客户端调用，思路最重要，代码就不贴了。</p>
  <h1 data-id="heading-21">node 端上传图片</h1>
  <p>不只会从客户端上传文件到服务器，服务器也会上传文件到其他服务器。</p>
  <ul>
    <li>读取文件buffer <code>fs</code></li>
    <li>构建 form-data <code>form-data</code></li>
    <li>上传文件 <code>node-fetch</code></li>
  </ul>
  <p><code>NODE</code></p>
  <pre><code lang="javascript" class="hljs language-javascript copyable"> <span class="hljs-comment">/**
     * filepath = 相对根目录的路径即可
     */</span>
   <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getFileBufer</span>(<span class="hljs-params">filePath</span>) =&gt; {

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
            fs.<span class="hljs-title function_">readFile</span>(filePath, <span class="hljs-keyword">function</span> (<span class="hljs-params">err, data</span>) {
                <span class="hljs-keyword">var</span> bufer = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">if</span> (!err) {
                    <span class="hljs-title function_">resolve</span>({
                        <span class="hljs-attr">err</span>: err,
                        <span class="hljs-attr">data</span>: data
                    });
                }

            });

        });
    }


    <span class="hljs-comment">/**
     * 上传文件
     */</span>
    <span class="hljs-keyword">let</span> fetch = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-fetch'</span>);
    <span class="hljs-keyword">let</span> formData = <span class="hljs-built_in">require</span>(<span class="hljs-string">'form-data'</span>);

    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">async</span> (options) =&gt; {
        <span class="hljs-keyword">let</span> {
            imgPath
        } = options;
        <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getFileBufer</span>(imgPath);
        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">err</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">let</span> form = <span class="hljs-keyword">new</span> <span class="hljs-title function_">formData</span>();
        form.<span class="hljs-title function_">append</span>(<span class="hljs-string">'xxx'</span>, xxx);
        form.<span class="hljs-title function_">append</span>(<span class="hljs-string">'pic'</span>, data.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'http://xx.com/upload'</span>, {
            <span class="hljs-attr">body</span>: form,
            <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
            <span class="hljs-attr">headers</span>: form.<span class="hljs-title function_">getHeaders</span>()<span class="hljs-comment">//要活的 form-data的头，否则无法上传</span>
        }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
        }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> data;
        })
    }
<span class="copy-code-btn">复制代码</span></code></pre><h1 data-id="heading-22">其他</h1>
  <h2 data-id="heading-23">在浏览器端对文件的类型、大小、尺寸进行判断</h2>
  <ul>
    <li><code>file.type</code>判断类型</li>
    <li><code>file.size</code>判断大小</li>
    <li>通过动态创建 img 标签，图片加载后获得尺寸,<code>naturalWidth naturalHeight</code>or <code>width height</code></li>
  </ul>
  <p><code>JS</code></p>
  <pre><code lang="kotlin" class="hljs language-kotlin copyable">    <span class="hljs-keyword">var</span> file = document.getElementById(<span class="hljs-string">'f1'</span>).files[<span class="hljs-number">0</span>];

    <span class="hljs-comment">//判断类型</span>
    <span class="hljs-keyword">if</span>(f.type!==<span class="hljs-string">'image/jpeg'</span> &amp;&amp;  f.type !== <span class="hljs-string">'image/jpg'</span>  ){
        alert(<span class="hljs-string">'只能上传 jpg 图片'</span>);
        flag=<span class="hljs-literal">false</span>;
        <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-comment">//判断大小</span>
    <span class="hljs-keyword">if</span>(file.size&gt;<span class="hljs-number">100</span>*<span class="hljs-number">1024</span>){
        alert(<span class="hljs-string">'不能大于100kb'</span>);
    }

    <span class="hljs-comment">//判断图片尺寸</span>
    <span class="hljs-keyword">var</span> img =new Image();
    img.onload=function(){
         console.log(<span class="hljs-string">'图片原始大小 width*height'</span>, <span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height);
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.naturalWidth){
        console.log(<span class="hljs-string">'图片原始大小 naturalWidth*naturalHeight'</span>, <span class="hljs-keyword">this</span>.naturalWidth, <span class="hljs-keyword">this</span>.naturalHeight);
        }<span class="hljs-keyword">else</span>{
          console.log(<span class="hljs-string">'oImg.width*height'</span>, <span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height);
        }
    }
<span class="copy-code-btn">复制代码</span></code></pre><h2 data-id="heading-24">input file 外观更改</h2>
  <p>由于input file 的外观比较传统，很多地方都需要进行美化。</p>
  <ol>
    <li>定义好一个外观，然后将 file input 定位到该元素上，让他的透明度为0。</li>
    <li>使用 label 标签</li>
  </ol>
  <pre><code lang="ini" class="hljs language-ini copyable">  &lt;label <span class="hljs-attr">for</span>=<span class="hljs-string">"file"</span>&gt;Choose file to upload&lt;/label&gt;
    &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> id=<span class="hljs-string">"file"</span> name=<span class="hljs-string">"file"</span> multiple&gt;
<span class="copy-code-btn">复制代码</span></code></pre><ol start="3">
    <li>隐藏 input file 标签，然后调用 input 元素的 click 方法</li>
  </ol>
  <p><strong>PS</strong></p>
  <p>file 标签隐藏后在 ie 下无法获得文件内容，建议还是<code>方法1</code> 兼容性强。</p>
  <h1 data-id="heading-25">源码在这里</h1>
  <p>以上代码均已上传 github</p>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBigerfe%2Ffe-learn-code%2F" title="https://github.com/Bigerfe/fe-learn-code/" ref="nofollow noopener noreferrer">github.com/Bigerfe/fe-…</a></p>
  <h1 data-id="heading-26">参考资料</h1>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FBlob" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></p>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FXMLHttpRequest" title="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></p>
  <p><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Fnews%2F323657" title="https://cloud.tencent.com/developer/news/323657" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/n…</a></p>
  <h1 data-id="heading-27">到这里请停一下</h1>
  <ul>
    <li>我正在打造一个纯技术交流群，以学习、交流、思考、提升能力为目标，因为一个人学不如大家一起学，有了更多的交流才会进步的更快。</li>
    <li>我理想的模式是，每期让一个人深入学习一个技术，然后自己再转述给大家听，类似一个分享课堂，这样可以成倍的提升学习效率</li>
    <li>在这个群里不用担心自己的能力不足，不用担心问题是否太小白而不敢说，大胆的说出问题， 让更多的人一起来分析，说错了也没关系</li>
    <li>有想入群的加我微信 <code>223344386</code> 回复加群即可</li>
  </ul>
  <p>希望本文可以给你带了一些帮助，文中如有错误，欢迎在评论区指。
    如果这篇文章帮助到了你，欢迎点赞和关注。</p>
  <p>另外推荐关注我的微信公众号【前端技术江湖】，除了深度好文，还有我有精心整理的【500道前端面试题】等你来查收。</p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/8/16e46ee0e85592d0~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/8/16e46eb33a23825f~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <h1 data-id="heading-28">其他</h1>
  <p><strong>你对 SSR 有兴趣吗？</strong></p>
  <p>如果你对 <code>服务端渲染 ssr</code> 技术有兴趣，可以关注我的开源项目：<code>Zz.js</code></p>
  <p>github:<a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBigerfe%2Fkoa-react-ssr" title="https://github.com/Bigerfe/koa-react-ssr" ref="nofollow noopener noreferrer">github.com/Bigerfe/koa…</a></p>
  <p>官网：<a target="_blank" href="https://link.juejin.cn?target=http%3A%2F%2Fzz.bigerfe.com%2F" title="http://zz.bigerfe.com/" ref="nofollow noopener noreferrer">zz.bigerfe.com/</a></p>
  <p>SSR 技术原理</p>
  <p><a target="_blank" href="https://juejin.cn/post/6844903943902855176" title="https://juejin.cn/post/6844903943902855176">juejin.cn/post/684490…</a></p>
</div>
